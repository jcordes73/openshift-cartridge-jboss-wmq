#!/bin/bash

# Embeds Oracle JDBC configuration into an JBoss EAP instance

source $OPENSHIFT_CARTRIDGE_SDK_BASH
source ${OPENSHIFT_JBOSSWMQ_DIR}/bin/util

case "$1" in
  -v|--version) wmq_version="$2"
  ;;
  *) wmq_version="7.0.1.7"
  ;;
esac

if  ! isrunning; then
  ${OPENSHIFT_JBOSSEAP_DIR}/bin/control start
fi

if  ! ismgmtup; then
  client_error "WebSphere MQ RAR cartridge 1.0.3 installation failed because JBoss management interface is not up."
  exit 1
fi

cp ${OPENSHIFT_JBOSSWMQ_DIR}/configuration/${wmq_version}/wmq.jmsra.rar ${OPENSHIFT_DEPENDENCIES_DIR}/jbosseap/deployments

echo "if (outcome != success) of /system-property=OPENSHIFT_JBOSSWMQ_JNDINAME:read-resource()" > ${OPENSHIFT_JBOSSWMQ_DIR}/configuration/set-properties.cli
echo "  /system-property=OPENSHIFT_JBOSSWMQ_JNDINAME:add(value=\"$OPENSHIFT_JBOSSWMQ_JNDINAME\")" >> ${OPENSHIFT_JBOSSWMQ_DIR}/configuration/set-properties.cli
echo "else" >> ${OPENSHIFT_JBOSSWMQ_DIR}/configuration/set-properties.cli
echo "  /system-property=OPENSHIFT_JBOSSWMQ_JNDINAME:write-attribute(name=value,value=\"$OPENSHIFT_JBOSSWMQ_JNDINAME\")" >> ${OPENSHIFT_JBOSSWMQ_DIR}/configuration/set-properties.cli
echo "end-if" >> ${OPENSHIFT_JBOSSWMQ_DIR}/configuration/set-properties.cli

echo "if (outcome != success) of /system-property=OPENSHIFT_JBOSSWMQ_CONNECTIONNAMELIST:read-resource()" >> ${OPENSHIFT_JBOSSWMQ_DIR}/configuration/set-properties.cli
echo "  /system-property=OPENSHIFT_JBOSSWMQ_CONNECTIONNAMELIST:add(value=\"$OPENSHIFT_JBOSSWMQ_CONNECTIONNAMELIST\")" >> ${OPENSHIFT_JBOSSWMQ_DIR}/configuration/set-properties.cli
echo "else" >> ${OPENSHIFT_JBOSSWMQ_DIR}/configuration/set-properties.cli
echo "  /system-property=OPENSHIFT_JBOSSWMQ_CONNECTIONNAMELIST:write-attribute(name=value,value=\"$OPENSHIFT_JBOSSWMQ_CONNECTIONNAMELIST\")" >> ${OPENSHIFT_JBOSSWMQ_DIR}/configuration/set-properties.cli
echo "end-if" >> ${OPENSHIFT_JBOSSWMQ_DIR}/configuration/set-properties.cli

echo "if (outcome != success) of /system-property=OPENSHIFT_JBOSSWMQ_CHANNEL:read-resource()" >> ${OPENSHIFT_JBOSSWMQ_DIR}/configuration/set-properties.cli
echo "  /system-property=OPENSHIFT_JBOSSWMQ_CHANNEL:add(value=\"$OPENSHIFT_JBOSSWMQ_CHANNEL\")" >> ${OPENSHIFT_JBOSSWMQ_DIR}/configuration/set-properties.cli
echo "else" >> ${OPENSHIFT_JBOSSWMQ_DIR}/configuration/set-properties.cli
echo "  /system-property=OPENSHIFT_JBOSSWMQ_CHANNEL:write-attribute(name=value,value=\"$OPENSHIFT_JBOSSWMQ_CHANNEL\")" >> ${OPENSHIFT_JBOSSWMQ_DIR}/configuration/set-properties.cli
echo "end-if" >> ${OPENSHIFT_JBOSSWMQ_DIR}/configuration/set-properties.cli

echo "if (outcome != success) of /system-property=OPENSHIFT_JBOSSWMQ_QUEUEMANAGER:read-resource()" >> ${OPENSHIFT_JBOSSWMQ_DIR}/configuration/set-properties.cli
echo "  /system-property=OPENSHIFT_JBOSSWMQ_QUEUEMANAGER:add(value=\"$OPENSHIFT_JBOSSWMQ_QUEUEMANAGER\")" >> ${OPENSHIFT_JBOSSWMQ_DIR}/configuration/set-properties.cli
echo "else" >> ${OPENSHIFT_JBOSSWMQ_DIR}/configuration/set-properties.cli
echo "  /system-property=OPENSHIFT_JBOSSWMQ_QUEUEMANAGER:write-attribute(name=value,value=\"$OPENSHIFT_JBOSSWMQ_QUEUEMANAGER\")" >> ${OPENSHIFT_JBOSSWMQ_DIR}/configuration/set-properties.cli
echo "end-if" >> ${OPENSHIFT_JBOSSWMQ_DIR}/configuration/set-properties.cli

execute_cli ${OPENSHIFT_JBOSSWMQ_DIR}/configuration/set-properties.cli
execute_cli ${OPENSHIFT_JBOSSWMQ_DIR}/configuration/install.cli

cp ${OPENSHIFT_JBOSSEAP_DIR}/standalone/configuration/standalone.xml ${OPENSHIFT_REPO_DIR}/.openshift/config/

${OPENSHIFT_JBOSSEAP_DIR}/bin/control restart
